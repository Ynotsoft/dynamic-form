name: Publish Libraries

on:
  push:
    branches:
      - main
    paths:
      - "packages/dynamic-form-lib/**"
      - "packages/dynamic-grid-lib/**"
  workflow_dispatch:
    inputs:
      target_package:
        description: "Which package to manually publish?"
        required: true
        default: "form"
        type: choice
        options:
          - form
          - grid
      version:
        description: "Version (e.g. 1.0.32). Leave blank for auto-detection from package.json"
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  # 1. Detect which package changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      form: ${{ steps.filter.outputs.form }}
      grid: ${{ steps.filter.outputs.grid }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            form:
              - 'packages/dynamic-form-lib/**'
            grid:
              - 'packages/dynamic-grid-lib/**'

  # 2. Job for Dynamic Form Library
  publish-form:
    needs: changes
    if: |
      needs.changes.outputs.form == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target_package == 'form')
    runs-on: ubuntu-latest
    env:
      PKG_PATH: "packages/dynamic-form-lib"
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Set up .npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

      - name: Install dependencies
        run: bun install --no-save

      - name: Build
        run: bun run build

      - name: Determine Version and Tag
        id: info
        run: |
          # Detect version from package.json
          VER=$(node -p "require('./${{ env.PKG_PATH }}/package.json').version")
          NAME=$(node -p "require('./${{ env.PKG_PATH }}/package.json').name")

          # Logic for dist-tag (latest vs next)
          if [[ "$VER" == *-* ]]; then TAG="next"; else TAG="latest"; fi

          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Check if version exists
        id: exists
        run: |
          if npm view "${{ steps.info.outputs.name }}@${{ steps.info.outputs.version }}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npm
        if: steps.exists.outputs.exists == 'false'
        run: |
          bun publish --cwd ${{ env.PKG_PATH }} --access public --provenance --tag "${{ steps.info.outputs.tag }}"

      - name: Promote existing version
        if: steps.exists.outputs.exists == 'true'
        run: |
          npm dist-tag add "${{ steps.info.outputs.name }}@${{ steps.info.outputs.version }}" "${{ steps.info.outputs.tag }}"

  # 3. Job for Dynamic Grid Library
  publish-grid:
    needs: changes
    if: |
      needs.changes.outputs.grid == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target_package == 'grid')
    runs-on: ubuntu-latest
    env:
      PKG_PATH: "packages/dynamic-grid-lib"
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Set up .npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

      - name: Install dependencies
        run: bun install --no-save

      - name: Build
        run: bun run build

      - name: Determine Version and Tag
        id: info
        run: |
          VER=$(node -p "require('./${{ env.PKG_PATH }}/package.json').version")
          NAME=$(node -p "require('./${{ env.PKG_PATH }}/package.json').name")
          if [[ "$VER" == *-* ]]; then TAG="next"; else TAG="latest"; fi
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Check if version exists
        id: exists
        run: |
          if npm view "${{ steps.info.outputs.name }}@${{ steps.info.outputs.version }}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npm
        if: steps.exists.outputs.exists == 'false'
        run: |
          bun publish --cwd ${{ env.PKG_PATH }} --access public --provenance --tag "${{ steps.info.outputs.tag }}" --dry-run
