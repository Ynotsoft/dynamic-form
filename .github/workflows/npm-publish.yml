name: Publish Libraries

on:
  push:
    branches:
      - main
    paths:
      - "packages/dynamic-form-lib/**"
      - "packages/dynamic-grid-lib/**"
      - "packages/dynamic-dialog-lib/**"
  workflow_dispatch:
    inputs:
      target_package:
        description: "Which package to manually publish?"
        required: true
        default: "form"
        type: choice
        options:
          - form
          - grid
          - dialog

permissions:
  contents: read
  id-token: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      form: ${{ steps.filter.outputs.form }}
      grid: ${{ steps.filter.outputs.grid }}
      dialog: ${{ steps.filter.outputs.dialog }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            form:
              - 'packages/dynamic-form-lib/**'
            grid:
              - 'packages/dynamic-grid-lib/**'
            dialog:
              - 'packages/dynamic-dialog-lib/**'

  publish-form:
    needs: changes
    if: |
      needs.changes.outputs.form == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target_package == 'form')
    runs-on: ubuntu-latest
    env:
      PKG_DIR: "packages/dynamic-form-lib"
      PKG_NAME: "ynotsoft-dynamic-form"
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Set up .npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

      - name: Install dependencies
        run: bun install --no-save

      - name: Build Library
        run: bun run --filter ${{ env.PKG_NAME }} build

      - name: Determine Version and Tag
        id: info
        run: |
          VER=$(node -p "require('./${{ env.PKG_DIR }}/package.json').version")
          NAME=$(node -p "require('./${{ env.PKG_DIR }}/package.json').name")
          if [[ "$VER" == *-* ]]; then TAG="next"; else TAG="latest"; fi
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate Version Bump
        run: |
          PKG="${{ steps.info.outputs.name }}"
          VER="${{ steps.info.outputs.version }}"
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "::error::Version $VER of $PKG already exists on NPM. Please bump the version in ${{ env.PKG_DIR }}/package.json"
            exit 1
          fi

      - name: Publish to npm
        run: |
          bun publish --cwd ${{ env.PKG_DIR }} --access public --provenance --tag "${{ steps.info.outputs.tag }}"

  publish-grid:
    needs: changes
    if: |
      needs.changes.outputs.grid == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target_package == 'grid')
    runs-on: ubuntu-latest
    env:
      PKG_DIR: "packages/dynamic-grid-lib"
      PKG_NAME: "ynotsoft-dynamic-grid"
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Set up .npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

      - name: Install dependencies
        run: bun install --no-save

      - name: Build Library
        run: bun run --filter ${{ env.PKG_NAME }} build

      - name: Determine Version and Tag
        id: info
        run: |
          VER=$(node -p "require('./${{ env.PKG_DIR }}/package.json').version")
          NAME=$(node -p "require('./${{ env.PKG_DIR }}/package.json').name")
          if [[ "$VER" == *-* ]]; then TAG="next"; else TAG="latest"; fi
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate Version Bump
        run: |
          PKG="${{ steps.info.outputs.name }}"
          VER="${{ steps.info.outputs.version }}"
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "::error::Version $VER of $PKG already exists on NPM. Please bump the version in ${{ env.PKG_DIR }}/package.json"
            exit 1
          fi

      - name: Publish to npm
        run: |
          bun publish --cwd ${{ env.PKG_DIR }} --access public --provenance --tag "${{ steps.info.outputs.tag }}"

  publish-dialog:
    needs: changes
    if: |
      needs.changes.outputs.dialog == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.target_package == 'dialog')
    runs-on: ubuntu-latest
    env:
      PKG_DIR: "packages/dynamic-dialog-lib"
      PKG_NAME: "ynotsoft-dynamic-dialog"
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1

      - name: Set up .npmrc
        run: echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc

      - name: Install dependencies
        run: bun install --no-save

      - name: Build Library
        run: bun run --filter ${{ env.PKG_NAME }} build

      - name: Determine Version and Tag
        id: info
        run: |
          VER=$(node -p "require('./${{ env.PKG_DIR }}/package.json').version")
          NAME=$(node -p "require('./${{ env.PKG_DIR }}/package.json').name")
          if [[ "$VER" == *-* ]]; then TAG="next"; else TAG="latest"; fi
          echo "version=$VER" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate Version Bump
        run: |
          PKG="${{ steps.info.outputs.name }}"
          VER="${{ steps.info.outputs.version }}"
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "::error::Version $VER of $PKG already exists on NPM. Please bump the version in ${{ env.PKG_DIR }}/package.json"
            exit 1
          fi

      - name: Publish to npm
        run: |
          bun publish --cwd ${{ env.PKG_DIR }} --access public --provenance --tag "${{ steps.info.outputs.tag }}"
